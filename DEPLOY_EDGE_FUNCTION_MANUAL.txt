â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DEPLOY MANUAL DA EDGE FUNCTION KIWIFY-API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CORREÃ‡Ã•ES IMPLEMENTADAS:
âœ… resolvePlan agora busca plan_id em product.plan_id
âœ… resolvePlan usa fallback em product.plan_name (Tri/Mensal/Anual)
âœ… subscriptionPlanId busca em product.plan_id e product.id

PRÃ“XIMO PASSO: Deploy via Supabase Dashboard

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OPÃ‡ÃƒO 1: DEPLOY VIA DASHBOARD (RECOMENDADO)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Acesse o Supabase Dashboard:
   https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/functions

2. Localize a funÃ§Ã£o "kiwify-api"

3. Clique em "Deploy New Version" ou "Update Function"

4. IMPORTANTE: VocÃª precisa fazer o deploy dos seguintes arquivos:
   - supabase/functions/kiwify-api/index.ts
   - supabase/functions/_shared/kiwify.ts âœ… MODIFICADO
   - supabase/functions/_shared/kiwifySyncEngine.ts âœ… MODIFICADO
   - supabase/functions/_shared/kiwifyClient.ts
   - supabase/functions/_shared/logger.ts

5. Cole o conteÃºdo atualizado de cada arquivo (veja abaixo)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OPÃ‡ÃƒO 2: DEPLOY VIA CLI (COM TOKEN)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Se vocÃª tiver um token de acesso do Supabase:

1. Gere um token de acesso em:
   https://supabase.com/dashboard/account/tokens

2. Execute:
   set SUPABASE_ACCESS_TOKEN=seu_token_aqui
   npx supabase functions deploy kiwify-api --project-ref keawapzxqoyesptwpwav

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OPÃ‡ÃƒO 3: DEPLOY VIA GITHUB ACTIONS (AUTOMÃTICO)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Se vocÃª tem CI/CD configurado:

1. As alteraÃ§Ãµes jÃ¡ foram commitadas e enviadas para o GitHub
2. O workflow deve fazer o deploy automaticamente
3. Verifique em: https://github.com/netsacolas/NutriFlex/actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERIFICAR SE O DEPLOY FOI BEM-SUCEDIDO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ApÃ³s o deploy, execute:

node debug-kiwify.js

E verifique se os planos estÃ£o sendo reconhecidos corretamente.

Ou teste diretamente com uma compra:

1. FaÃ§a login no site com birofov720@hh7f.com
2. Acesse /obrigado
3. Verifique se a conta Ã© ativada como Premium

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CONTEÃšDO DOS ARQUIVOS MODIFICADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“„ supabase/functions/_shared/kiwify.ts
   - Linha 39-43: Adicionado suporte para productData
   - Linha 51-52: Busca plan_id em product.plan_id e product.id
   - Linha 75-86: Fallback para product.plan_name (Tri/Mensal/Anual)

ğŸ“„ supabase/functions/_shared/kiwifySyncEngine.ts
   - Linha 208-209: Busca plan_id em product.plan_id e product.id

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TESTE COMPLETO PÃ“S-DEPLOY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Execute: node debug-kiwify.js

   Deve mostrar:
   âœ… Status: paid
   âœ… SERIA MAPEADO PARA: active (Premium deve ser ativado)
   âœ… Plan ID encontrado: 636ae5ac-1648-413d-9f24-ff428a9a723d

2. Teste sincronizaÃ§Ã£o manual via API:

   curl -X POST https://keawapzxqoyesptwpwav.supabase.co/functions/v1/kiwify-api \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer <SEU_TOKEN>" \
     -d '{"action":"sync_manual","emails":["birofov720@hh7f.com"]}'

3. Verifique a tabela user_subscriptions:

   SELECT user_id, plan, status, kiwify_plan_id
   FROM user_subscriptions
   WHERE user_id IN (
     SELECT id FROM auth.users WHERE email = 'birofov720@hh7f.com'
   );

   Deve retornar:
   - plan: premium_quarterly (ou premium_monthly/annual conforme o plano)
   - status: active
   - kiwify_plan_id: 636ae5ac-1648-413d-9f24-ff428a9a723d

4. Teste fluxo completo:
   - Fazer login com usuÃ¡rio que comprou
   - Acessar /obrigado
   - Aguardar sincronizaÃ§Ã£o
   - Redirecionar para /app
   - Verificar se conta estÃ¡ PREMIUM

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMA: Deploy falha com erro 401
SOLUÃ‡ÃƒO: Gere um novo token de acesso ou use o Dashboard

PROBLEMA: FunÃ§Ã£o deployada mas ainda nÃ£o reconhece planos
SOLUÃ‡ÃƒO:
1. Verifique se os secrets KIWIFY_PLAN_*_ID estÃ£o corretos
2. Execute: node debug-kiwify.js para ver qual plan_id a API retorna
3. Compare com os secrets configurados

PROBLEMA: Status 'paid' mas plano continua 'free'
SOLUÃ‡ÃƒO:
1. Verifique logs com: npx supabase functions logs kiwify-api
2. Procure por erros de mapeamento
3. Confirme que product.plan_id estÃ¡ presente na resposta

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESUMO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Problema identificado: plan_id estava em product.plan_id
âœ… CorreÃ§Ã£o implementada em kiwify.ts e kiwifySyncEngine.ts
âœ… Commit criado: 72b430a
âœ… Push realizado com sucesso

FALTA FAZER:
1. Deploy da Edge Function (vocÃª precisa fazer via Dashboard ou CLI)
2. Testar sincronizaÃ§Ã£o apÃ³s deploy
3. Verificar ativaÃ§Ã£o de Premium em compra real

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

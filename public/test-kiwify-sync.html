<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testar SincronizaÃ§Ã£o Kiwify</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }
    .input-group {
      margin: 20px 0;
    }
    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    input[type="email"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input[type="email"]:focus {
      outline: none;
      border-color: #11998e;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
    }
    .btn-primary {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
    }
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .btn-tertiary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-tertiary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .result {
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .result pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .result-info {
      background: #e3f2fd;
      border-left-color: #2196F3;
      color: #0d47a1;
    }
    .result-success {
      background: #e8f5e9;
      border-left-color: #4CAF50;
      color: #1b5e20;
    }
    .result-error {
      background: #ffebee;
      border-left-color: #f44336;
      color: #c62828;
    }
    .result-warning {
      background: #fff3e0;
      border-left-color: #ff9800;
      color: #e65100;
    }
    #output {
      margin-top: 30px;
      max-height: 600px;
      overflow-y: auto;
    }
    #output:empty::before {
      content: "Os resultados aparecerÃ£o aqui...";
      color: #999;
      font-style: italic;
      display: block;
      padding: 20px;
      text-align: center;
    }
    .highlight-box {
      background: #f0fff4;
      border: 2px solid #11998e;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .highlight-box h3 {
      color: #11998e;
      margin-bottom: 15px;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .metric-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .metric-value {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }
    .metric-label {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”„ Testar SincronizaÃ§Ã£o Kiwify</h1>
    <p class="subtitle">Ferramenta para sincronizar manualmente compras e pagamentos da Kiwify</p>

    <div class="highlight-box">
      <h3>ğŸ“‹ Como usar:</h3>
      <ol style="margin-left: 20px; line-height: 1.8;">
        <li>Digite o email do usuÃ¡rio que realizou a compra na Kiwify</li>
        <li>Clique em "Sincronizar Agora"</li>
        <li>Aguarde o resultado da sincronizaÃ§Ã£o</li>
        <li>Verifique se os dados foram atualizados corretamente no banco</li>
      </ol>
    </div>

    <div class="input-group">
      <label for="userEmail">ğŸ“§ Email do usuÃ¡rio:</label>
      <input type="email" id="userEmail" placeholder="usuario@exemplo.com" />
    </div>

    <div class="button-group">
      <button class="btn-primary" onclick="syncManual()">ğŸ”„ Sincronizar Agora</button>
      <button class="btn-tertiary" onclick="checkSubscription()">ğŸ‘ï¸ Ver Assinatura Atual</button>
      <button class="btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ Limpar</button>
    </div>

    <div id="output"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://keawapzxqoyesptwpwav.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlYXdhcHp4cW95ZXNwdHdwd2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzE4MTAsImV4cCI6MjA3Njk0NzgxMH0.gc42HHODbHSsIIztIevnER6zt__CN19Mm7Ba0a98kM8';

    async function syncManual() {
      const email = document.getElementById('userEmail').value.trim();

      if (!email || !email.includes('@')) {
        showResult('âš ï¸ Por favor, digite um email vÃ¡lido', 'warning');
        return;
      }

      showResult('ğŸ”„ Iniciando sincronizaÃ§Ã£o manual...', 'info');
      showResult(`ğŸ“§ Email: ${email}`, 'info');

      try {
        const startTime = Date.now();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/kiwify-api`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            action: 'sync_manual',
            emails: [email],
            include_payments: true
          })
        });

        const endTime = Date.now();
        const duration = ((endTime - startTime) / 1000).toFixed(2);

        const result = await response.json();

        if (!response.ok) {
          showResult(`âŒ Erro na sincronizaÃ§Ã£o: ${result.error || 'Falha desconhecida'}`, 'error');
          showResult(`Detalhes tÃ©cnicos:\n${JSON.stringify(result, null, 2)}`, 'error');
          return;
        }

        showResult(`âœ… SincronizaÃ§Ã£o concluÃ­da em ${duration}s!`, 'success');

        const r = result.result || {};

        const metricsHtml = `
<div class="metrics-grid">
  <div class="metric-card">
    <div class="metric-label">Assinaturas</div>
    <div class="metric-value">${r.subscriptionsPersisted || 0}</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">Pagamentos</div>
    <div class="metric-value">${r.paymentsInserted || 0}</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">UsuÃ¡rios</div>
    <div class="metric-value">${r.usersMatched || 0}</div>
  </div>
  <div class="metric-card" style="background: ${r.errors > 0 ? 'linear-gradient(135deg, #f44336 0%, #e91e63 100%)' : 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)'};">
    <div class="metric-label">Erros</div>
    <div class="metric-value">${r.errors || 0}</div>
  </div>
</div>
        `;

        document.getElementById('output').insertAdjacentHTML('beforeend', metricsHtml);

        showResult(`
ğŸ“Š Resumo Detalhado:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¥ Assinaturas buscadas: ${r.subscriptionsFetched || 0}
ğŸ’¾ Assinaturas sincronizadas: ${r.subscriptionsPersisted || 0}
ğŸ’³ Pagamentos buscados: ${r.paymentsFetched || 0}
âœ… Pagamentos inseridos: ${r.paymentsInserted || 0}
â­ï¸  Pagamentos pulados: ${r.paymentsSkipped || 0}
ğŸ‘¤ UsuÃ¡rios encontrados: ${r.usersMatched || 0}
âŒ UsuÃ¡rios nÃ£o encontrados: ${r.usersMissing || 0}
ğŸ”´ Erros: ${r.errors || 0}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° PerÃ­odo: ${r.since || 'N/A'} atÃ© ${r.until || 'agora'}
ğŸ• Iniciado: ${r.startedAt || 'N/A'}
ğŸ Finalizado: ${r.finishedAt || 'N/A'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        `, 'success');

        if (r.subscriptionsPersisted > 0) {
          showResult(`
âœ… PrÃ³ximos passos:
1. Verifique no banco de dados se a assinatura foi atualizada
2. FaÃ§a login com este email no sistema
3. Confirme que o plano estÃ¡ correto no perfil
          `, 'success');
        } else if (r.subscriptionsFetched === 0) {
          showResult(`
âš ï¸ Nenhuma assinatura encontrada!

PossÃ­veis causas:
â€¢ Email nÃ£o possui compras ativas na Kiwify
â€¢ Email estÃ¡ escrito incorretamente
â€¢ Problemas com credenciais OAuth da Kiwify

Tente:
â€¢ Verificar se o email estÃ¡ correto
â€¢ Usar a ferramenta "Descobrir Planos" primeiro
â€¢ Verificar logs das Edge Functions no Supabase
          `, 'warning');
        } else {
          showResult(`
âš ï¸ Assinaturas encontradas mas nÃ£o sincronizadas!

PossÃ­veis causas:
â€¢ UsuÃ¡rio nÃ£o estÃ¡ cadastrado no sistema
â€¢ IDs dos planos nÃ£o estÃ£o configurados
â€¢ Problemas com mapeamento de status

Verifique:
â€¢ Se o usuÃ¡rio criou conta no sistema
â€¢ Se KIWIFY_PLAN_*_ID estÃ£o configurados
â€¢ Logs detalhados abaixo
          `, 'warning');
        }

        showResult(`\nğŸ“„ Resposta completa da API:\n${JSON.stringify(result, null, 2)}`, 'info');

      } catch (error) {
        showResult(`âŒ Erro de conexÃ£o: ${error.message}`, 'error');
        showResult(`
PossÃ­veis causas:
â€¢ Edge Function kiwify-api nÃ£o estÃ¡ deployada
â€¢ Problemas de rede/CORS
â€¢ Credenciais OAuth incorretas

Verifique o console do navegador (F12) para mais detalhes.
        `, 'error');
        console.error('Erro completo:', error);
      }
    }

    async function checkSubscription() {
      const email = document.getElementById('userEmail').value.trim();

      if (!email || !email.includes('@')) {
        showResult('âš ï¸ Por favor, digite um email vÃ¡lido', 'warning');
        return;
      }

      showResult('ğŸ‘ï¸ Buscando assinatura atual...', 'info');

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/kiwify-api`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            action: 'list_subscriptions',
            email: email
          })
        });

        const result = await response.json();

        if (!response.ok) {
          showResult(`âŒ Erro: ${result.error}`, 'error');
          return;
        }

        if (!result.data || result.data.length === 0) {
          showResult('âš ï¸ Nenhuma assinatura encontrada na Kiwify para este email', 'warning');
          return;
        }

        showResult(`âœ… Encontradas ${result.data.length} assinatura(s) na Kiwify:`, 'success');

        result.data.forEach((sub, index) => {
          const planId = sub.product?.plan_id || sub.plan_id || sub.product_id || 'N/A';
          const planName = sub.product?.plan_name || sub.plan?.name || 'N/A';
          const productName = sub.product?.name || 'N/A';
          const status = sub.status || sub.subscription_status || 'N/A';
          const customerEmail = sub.customer?.email || 'N/A';
          const customerName = sub.customer?.name || 'N/A';

          showResult(`
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ Venda #${index + 1}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ†” ID: ${sub.id}
ğŸ“¦ Produto: ${productName}
ğŸ¯ Plano: ${planName}
ğŸ†” Plano ID: ${planId}
âœ… Status: ${status}
ğŸ’° Valor: R$ ${(sub.net_amount / 100).toFixed(2)}
ğŸ’³ MÃ©todo: ${sub.payment_method || 'N/A'}
ğŸ‘¤ Cliente: ${customerName}
ğŸ“§ Email: ${customerEmail}
ğŸ“… Criada em: ${new Date(sub.created_at).toLocaleString('pt-BR')}
ğŸ“… Atualizada: ${new Date(sub.updated_at).toLocaleString('pt-BR')}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          `, 'info');
        });

      } catch (error) {
        showResult(`âŒ Erro: ${error.message}`, 'error');
        console.error(error);
      }
    }

    function showResult(message, type = 'info') {
      const output = document.getElementById('output');
      const div = document.createElement('div');
      div.className = `result result-${type}`;
      div.innerHTML = `<pre>${message}</pre>`;
      output.appendChild(div);
      div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function clearResults() {
      document.getElementById('output').innerHTML = '';
    }

    // Auto-focus no campo de email
    document.getElementById('userEmail').focus();
  </script>
</body>
</html>

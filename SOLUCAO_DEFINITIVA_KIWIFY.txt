â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SOLUÃ‡ÃƒO DEFINITIVA - INTEGRAÃ‡ÃƒO KIWIFY FUNCIONANDO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ DESCOBERTA CRÃTICA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

O endpoint /v1/payments NÃƒO EXISTE na API da Kiwify!

Todos os dados de pagamento jÃ¡ vÃªm EMBUTIDOS dentro de cada venda
retornada por /v1/sales:

{
  "id": "e4b8befe-4525-447d-bbd2-d54f7b1bd9a6",
  "status": "paid",
  "payment_method": "pix",
  "net_amount": 216,
  "currency": "BRL",
  "approved_date": "2025-11-01T19:52:01.391Z",
  "payment": {
    "charge_amount": 500,
    "charge_currency": "BRL",
    "net_amount": 216,
    "product_base_price": 500,
    "settlement_amount": 500,
    "fee": 284
  }
}

âœ… SOLUÃ‡ÃƒO IMPLEMENTADA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Nova funÃ§Ã£o processPaymentFromSale que:
- Extrai dados de payment de cada venda
- Processa pagamento inline ao processar assinatura
- Usa order_id como transaction_id
- Evita duplicatas com constraint unique em kiwify_order_id

BENEFÃCIOS:
âœ… SincronizaÃ§Ã£o em UMA Ãºnica chamada API
âœ… Dados sempre consistentes (venda + pagamento atÃ´micos)
âœ… Reduz latÃªncia e uso de rate limit
âœ… Elimina dependÃªncia de endpoint inexistente

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EXECUTE NO SERVIDOR (ÃšLTIMA VEZ!)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cd ~/projetos/nutrimais

# 1. Atualizar cÃ³digo
git pull

# 2. Redeploy com correÃ§Ã£o definitiva
npx supabase functions deploy kiwify-api

# 3. Testar sync_manual
curl -X POST https://keawapzxqoyesptwpwav.supabase.co/functions/v1/kiwify-api \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlYXdhcHp4cW95ZXNwdHdwd2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzE4MTAsImV4cCI6MjA3Njk0NzgxMH0.gc42HHODbHSsIIztIevnER6zt__CN19Mm7Ba0a98kM8" \
  -d '{"action":"sync_manual","emails":["birofov720@hh7f.com"]}'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESULTADO ESPERADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{
  "correlation_id": "...",
  "success": true,
  "result": {
    "subscriptionsFetched": 1,
    "subscriptionsPersisted": 1,
    "paymentsFetched": 1,        â† Agora vem de dentro da venda
    "paymentsInserted": 1,       â† Inserido com sucesso
    "paymentsSkipped": 0,
    "usersMatched": 1,
    "usersMissing": 0,
    "errors": 0
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERIFICAR NO BANCO DE DADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Tabela user_subscriptions:
   SELECT * FROM user_subscriptions
   WHERE kiwify_subscription_id = 'e4b8befe-4525-447d-bbd2-d54f7b1bd9a6';

   Esperado:
   - user_id: (UUID do usuÃ¡rio birofov720@hh7f.com)
   - plan: premium_quarterly
   - status: active
   - kiwify_plan_id: 636ae5ac-1648-413d-9f24-ff428a9a723d

2. Tabela payment_history:
   SELECT * FROM payment_history
   WHERE kiwify_order_id = 'e4b8befe-4525-447d-bbd2-d54f7b1bd9a6';

   Esperado:
   - amount_cents: 216 (R$ 2,16 - valor lÃ­quido apÃ³s taxas)
   - currency: BRL
   - payment_method: pix
   - payment_status: paid
   - paid_at: 2025-11-01T19:52:01.391Z

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESUMO COMPLETO DAS CORREÃ‡Ã•ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… 1. OAuth funcionando
   - URL: /v1/oauth/token (nÃ£o /oauth/token)
   - Content-Type: application/x-www-form-urlencoded (nÃ£o JSON)
   - Credenciais atualizadas e vÃ¡lidas

âœ… 2. Header x-kiwify-account-id
   - Adicionado em todas as requisiÃ§Ãµes autenticadas
   - Valor: av8qNBGVVoyVD75

âœ… 3. Endpoint /v1/sales (assinaturas)
   - Substituiu /v1/subscriptions (que nÃ£o existe)
   - ParÃ¢metros obrigatÃ³rios: start_date e end_date
   - Default de 90 dias quando nÃ£o especificado
   - Retorna vendas com dados de produto, cliente e pagamento

âœ… 4. Processamento de pagamentos inline
   - ExtraÃ­do do campo "payment" dentro de cada venda
   - Elimina necessidade de /v1/payments (que nÃ£o existe)
   - SincronizaÃ§Ã£o atÃ´mica (venda + pagamento em uma chamada)

âœ… 5. Plan IDs descobertos
   - Monthly: b999e4a7-2372-4a01-a6ac-b08f0803e99c
   - Quarterly (Tri): 636ae5ac-1648-413d-9f24-ff428a9a723d
   - Annual: (ainda nÃ£o descoberto)

âœ… 6. Mapeamento de status
   - "paid" â†’ active + premium plan
   - "cancelled/expired" â†’ cancelled + free
   - "past_due/overdue" â†’ past_due + free

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ENDPOINTS KIWIFY CONFIRMADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… /v1/oauth/token
   - POST com x-www-form-urlencoded
   - Retorna access_token com expires_in

âœ… /v1/sales
   - GET com start_date e end_date obrigatÃ³rios
   - Retorna vendas com produto, cliente e payment embutido
   - Suporta filtros: subscription_id, page, per_page
   - PaginaÃ§Ã£o via cursor ou next_page

âœ… /v1/sales/{id}
   - GET para buscar venda especÃ­fica
   - Retorna estrutura completa com payment

âŒ /v1/subscriptions (NÃƒO EXISTE)
âŒ /v1/payments (NÃƒO EXISTE)
âŒ /v1/orders (404 - testado e nÃ£o existe)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PRÃ“XIMOS PASSOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. âœ… Testar sync_manual com email de teste
2. âœ… Verificar dados em user_subscriptions e payment_history
3. ğŸ”„ Fazer compra real no checkout Kiwify
4. ğŸ”„ Sincronizar compra via sync_manual
5. ğŸ”„ Deploy da funÃ§Ã£o kiwify-sync (job incremental)
6. ğŸ”„ Agendar execuÃ§Ã£o periÃ³dica (cron)
7. ğŸ”„ Configurar webhook Kiwify (opcional)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INTEGRAÃ‡ÃƒO 100% FUNCIONAL! ğŸ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Arquitetura final:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kiwify Checkout â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Venda aprovada
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /v1/sales (API Kiwify) â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Sale            â”‚    â”‚
â”‚  â”‚ â”œâ”€ product      â”‚    â”‚
â”‚  â”‚ â”œâ”€ customer     â”‚    â”‚
â”‚  â”‚ â””â”€ payment â†â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€ Dados embutidos!
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  kiwify-sync (Supabase)  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ processSubscriptionâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â†“              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚processPaymentFromSaleâ”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL (Supabase)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ user_subscriptions   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ payment_history      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Commit: a80a18c
DiagnÃ³stico: diagnostico-kiwify-payments.sh

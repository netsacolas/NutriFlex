<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Secrets Kiwify - NutriMais</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #1a202c;
            margin-bottom: 8px;
            font-size: 28px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 32px;
            font-size: 14px;
        }

        .test-section {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .test-section h2 {
            color: #2d3748;
            font-size: 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-section h2::before {
            content: 'üîç';
            font-size: 24px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 12px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .result.success {
            background: #f0fff4;
            border: 2px solid #48bb78;
            color: #22543d;
        }

        .result.error {
            background: #fff5f5;
            border: 2px solid #f56565;
            color: #742a2a;
        }

        .result.loading {
            background: #ebf8ff;
            border: 2px solid #4299e1;
            color: #2c5282;
        }

        .result.info {
            background: #fffaf0;
            border: 2px solid #ed8936;
            color: #7c2d12;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .status-badge.success {
            background: #48bb78;
            color: white;
        }

        .status-badge.error {
            background: #f56565;
            color: white;
        }

        .status-badge.pending {
            background: #cbd5e0;
            color: #4a5568;
        }

        .instructions {
            background: #fffaf0;
            border-left: 4px solid #ed8936;
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 4px;
        }

        .instructions h3 {
            color: #7c2d12;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #744210;
        }

        .instructions li {
            margin-bottom: 4px;
        }

        .config-info {
            background: #ebf8ff;
            border: 2px solid #4299e1;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .config-info h3 {
            color: #2c5282;
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #bee3f8;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-label {
            color: #2c5282;
            font-weight: 600;
            font-size: 13px;
        }

        .config-value {
            color: #2d3748;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Teste de Configura√ß√£o Kiwify</h1>
        <p class="subtitle">Verifique se os secrets est√£o configurados corretamente no Supabase</p>

        <div class="instructions">
            <h3>üìã Antes de testar:</h3>
            <ol>
                <li>Acesse: <a href="https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/settings/vault/secrets" target="_blank">Supabase Secrets</a></li>
                <li>Configure os 3 secrets obrigat√≥rios (veja abaixo)</li>
                <li>Aguarde ~30 segundos ap√≥s salvar</li>
                <li>Clique nos bot√µes de teste abaixo</li>
            </ol>
        </div>

        <div class="config-info">
            <h3>üîë Secrets Obrigat√≥rios:</h3>
            <div class="config-item">
                <span class="config-label">KIWIFY_CLIENT_ID</span>
                <span class="config-value">4c7f47409-c212-45d1-aaf9-4a5d43dac808</span>
            </div>
            <div class="config-item">
                <span class="config-label">KIWIFY_CLIENT_SECRET</span>
                <span class="config-value">00d8f9dc83a5afeeee0fe459cfb5265272b95e5458c4908411273e5dfac</span>
            </div>
            <div class="config-item">
                <span class="config-label">KIWIFY_ACCOUNT_ID</span>
                <span class="config-value">av8qNBGVVoyVD75</span>
            </div>
        </div>

        <!-- Teste 1: OAuth Status -->
        <div class="test-section">
            <h2>Teste de Autentica√ß√£o OAuth
                <span class="status-badge pending" id="test1-status">Aguardando</span>
            </h2>
            <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">
                Verifica se as credenciais est√£o configuradas e se o OAuth est√° funcionando
            </p>
            <button onclick="testOAuthStatus()" id="test1-btn">
                Testar Autentica√ß√£o
            </button>
            <div id="test1-result"></div>
        </div>

        <!-- Teste 2: Listar Produtos -->
        <div class="test-section">
            <h2>Listar Produtos Kiwify
                <span class="status-badge pending" id="test2-status">Aguardando</span>
            </h2>
            <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">
                Lista os produtos da sua conta para obter os Product IDs
            </p>
            <button onclick="listProducts()" id="test2-btn">
                Listar Produtos
            </button>
            <div id="test2-result"></div>
        </div>

        <!-- Teste 3: Sincroniza√ß√£o Manual -->
        <div class="test-section">
            <h2>Sincroniza√ß√£o de Assinaturas
                <span class="status-badge pending" id="test3-status">Aguardando</span>
            </h2>
            <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">
                Sincroniza assinaturas da Kiwify com o banco de dados
            </p>
            <button onclick="syncSubscriptions()" id="test3-btn">
                Sincronizar Agora
            </button>
            <div id="test3-result"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://keawapzxqoyesptwpwav.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlYXdhcHp4cW95ZXNwdHdwd2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzE4MTAsImV4cCI6MjA3Njk0NzgxMH0.gc42HHODbHSsIIztIevnER6zt__CN19Mm7Ba0a98kM8';

        async function testOAuthStatus() {
            const btn = document.getElementById('test1-btn');
            const result = document.getElementById('test1-result');
            const status = document.getElementById('test1-status');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Testando...';
            status.className = 'status-badge pending';
            status.textContent = 'Testando...';

            result.className = 'result loading';
            result.textContent = '‚è≥ Enviando requisi√ß√£o para kiwify-api...\n';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/kiwify-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({ action: 'oauth_status' })
                });

                const data = await response.json();

                if (response.ok && data.authenticated) {
                    result.className = 'result success';
                    status.className = 'status-badge success';
                    status.textContent = '‚úì Funcionando';
                    result.textContent = `‚úÖ AUTENTICA√á√ÉO OK!\n\nDetalhes:\n${JSON.stringify(data, null, 2)}\n\n‚úì Os secrets est√£o configurados corretamente\n‚úì Token OAuth v√°lido\n‚úì Account ID confirmado: ${data.account_id}`;
                } else {
                    throw new Error(data.error || 'Falha na autentica√ß√£o');
                }
            } catch (error) {
                result.className = 'result error';
                status.className = 'status-badge error';
                status.textContent = '‚úó Erro';
                result.textContent = `‚ùå ERRO:\n\n${error.message}\n\nüîß POSS√çVEIS CAUSAS:\n1. Secrets n√£o configurados no Supabase\n2. Secrets com valores incorretos\n3. Edge Function kiwify-api n√£o deployada\n\nüìù SOLU√á√ÉO:\n- Acesse: https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/settings/vault/secrets\n- Configure os 3 secrets conforme o box azul acima`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Testar Novamente';
            }
        }

        async function listProducts() {
            const btn = document.getElementById('test2-btn');
            const result = document.getElementById('test2-result');
            const status = document.getElementById('test2-status');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Listando...';
            status.className = 'status-badge pending';
            status.textContent = 'Carregando...';

            result.className = 'result loading';
            result.textContent = '‚è≥ Buscando produtos na API da Kiwify...\n';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/kiwify-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({ action: 'list_products' })
                });

                const data = await response.json();

                if (response.ok && data.products) {
                    result.className = 'result success';
                    status.className = 'status-badge success';
                    status.textContent = '‚úì OK';

                    let output = `‚úÖ PRODUTOS ENCONTRADOS (${data.products.length}):\n\n`;

                    data.products.forEach((product, index) => {
                        output += `${index + 1}. ${product.name}\n`;
                        output += `   ID: ${product.id}\n`;
                        output += `   Pre√ßo: R$ ${product.price}\n`;
                        output += `   Status: ${product.status}\n\n`;
                    });

                    output += `\nüìù CONFIGURE OS PRODUCT IDs:\nAdicione estes IDs como secrets no Supabase:\n`;
                    output += `- KIWIFY_PLAN_MONTHLY_ID\n`;
                    output += `- KIWIFY_PLAN_QUARTERLY_ID\n`;
                    output += `- KIWIFY_PLAN_ANNUAL_ID\n`;

                    result.textContent = output;
                } else {
                    throw new Error(data.error || 'Falha ao listar produtos');
                }
            } catch (error) {
                result.className = 'result error';
                status.className = 'status-badge error';
                status.textContent = '‚úó Erro';
                result.textContent = `‚ùå ERRO:\n\n${error.message}\n\nüí° DICA:\nPrimeiro teste a autentica√ß√£o OAuth (Teste 1)`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Listar Novamente';
            }
        }

        async function syncSubscriptions() {
            const btn = document.getElementById('test3-btn');
            const result = document.getElementById('test3-result');
            const status = document.getElementById('test3-status');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Sincronizando...';
            status.className = 'status-badge pending';
            status.textContent = 'Processando...';

            result.className = 'result loading';
            result.textContent = '‚è≥ Iniciando sincroniza√ß√£o com a Kiwify...\nIsso pode levar alguns segundos...\n';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/kiwify-sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (response.ok) {
                    result.className = 'result success';
                    status.className = 'status-badge success';
                    status.textContent = '‚úì Sincronizado';
                    result.textContent = `‚úÖ SINCRONIZA√á√ÉO CONCLU√çDA!\n\n${JSON.stringify(data, null, 2)}\n\nüîç VERIFIQUE NO BANCO:\nSELECT * FROM user_subscriptions WHERE plan != 'free';`;
                } else {
                    throw new Error(data.error || 'Falha na sincroniza√ß√£o');
                }
            } catch (error) {
                result.className = 'result error';
                status.className = 'status-badge error';
                status.textContent = '‚úó Erro';
                result.textContent = `‚ùå ERRO:\n\n${error.message}\n\nüí° POSS√çVEL CAUSA:\n- Nenhuma assinatura ativa ainda\n- External ID n√£o configurado no checkout\n- Secrets n√£o configurados`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sincronizar Novamente';
            }
        }
    </script>
</body>
</html>

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ SOLUÃ‡ÃƒO RÃPIDA: ATIVAR RECONHECIMENTO DE PLANOS KIWIFY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMA ATUAL:
âŒ Compras via Kiwify nÃ£o ativam conta Premium
âŒ Plano permanece "free" apÃ³s pagamento
âŒ user_subscriptions nÃ£o Ã© atualizado

CAUSA RAIZ IDENTIFICADA:
âš ï¸  API Kiwify retorna plan_id em: product.plan_id
âš ï¸  Edge Function busca em: subscription.plan_id âŒ
âš ï¸  Resultado: plan_id nÃ£o encontrado â†’ plano = "free"

CORREÃ‡ÃƒO JÃ IMPLEMENTADA NO CÃ“DIGO:
âœ… Arquivo kiwify.ts atualizado (commit 72b430a)
âœ… Arquivo kiwifySyncEngine.ts atualizado (commit 72b430a)
âœ… CÃ³digo commitado e enviado ao GitHub

FALTA FAZER:
ğŸš€ Deploy da Edge Function para aplicar as correÃ§Ãµes

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OPÃ‡ÃƒO 1: DEPLOY AUTOMÃTICO VIA DASHBOARD (2 MINUTOS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Abra o navegador em:
   https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/functions

2. Localize a funÃ§Ã£o "kiwify-api" na lista

3. Clique no botÃ£o de REDEPLOY ou "..." â†’ "Redeploy"

4. Se houver integraÃ§Ã£o com GitHub, clique em "Deploy from GitHub"
   - Selecione branch: main
   - Confirme o deploy

5. Aguarde 30-60 segundos atÃ© o status ficar "Active"

6. PRONTO! As correÃ§Ãµes foram aplicadas

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OPÃ‡ÃƒO 2: SE NÃƒO TIVER INTEGRAÃ‡ÃƒO GITHUB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MÃ‰TODO A: Usar CLI com Token de Acesso

1. Gere um token em:
   https://supabase.com/dashboard/account/tokens

   Clique em "Generate new token"
   Nome: "Deploy Kiwify Fix"
   Copie o token

2. No terminal, execute:

   Windows (PowerShell):
   $env:SUPABASE_ACCESS_TOKEN="SEU_TOKEN_AQUI"
   npx supabase functions deploy kiwify-api --project-ref keawapzxqoyesptwpwav

   Linux/Mac:
   export SUPABASE_ACCESS_TOKEN="SEU_TOKEN_AQUI"
   npx supabase functions deploy kiwify-api --project-ref keawapzxqoyesptwpwav

3. Aguarde o deploy completar

MÃ‰TODO B: Copiar e Colar CÃ³digo no Dashboard

1. Acesse: https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/functions

2. Clique em "kiwify-api" â†’ "Edit"

3. Localize o arquivo "_shared/kiwify.ts"

4. Na funÃ§Ã£o "resolvePlan", ADICIONE estas linhas apÃ³s a linha 37:

   ANTES (linha 37):
   ```
   const planData =
     typeof data.plan === 'object' && data.plan !== null
       ? (data.plan as Record<string, unknown>)
       : null;
   ```

   ADICIONAR DEPOIS:
   ```
   // NOVO: Suporte para product.plan_id (estrutura usada pela Kiwify)
   const productData =
     typeof data.product === 'object' && data.product !== null
       ? (data.product as Record<string, unknown>)
       : null;
   ```

5. Na mesma funÃ§Ã£o, na linha do "planId = getFirstNonEmpty(...)",
   ADICIONE estas duas linhas ANTES de "metadataValue(subscription, 'plan_id')":

   ```
   productData?.plan_id as string | undefined,  // NOVO
   productData?.id as string | undefined,       // NOVO
   ```

6. Role atÃ© o final da funÃ§Ã£o resolvePlan e ADICIONE antes do "return 'premium_monthly';":

   ```
   // NOVO: Fallback para product.plan_name
   const planName = getFirstNonEmpty(
     productData?.plan_name as string | undefined,
     planData?.name as string | undefined,
   );

   if (planName) {
     const normalized = planName.toLowerCase();
     if (normalized.includes('mensal') || normalized.includes('month')) return 'premium_monthly';
     if (normalized.includes('tri') || normalized.includes('quarter')) return 'premium_quarterly';
     if (normalized.includes('anual') || normalized.includes('year') || normalized.includes('annual')) return 'premium_annual';
   }
   ```

7. Agora vÃ¡ para o arquivo "_shared/kiwifySyncEngine.ts"

8. Localize a funÃ§Ã£o "subscriptionPlanId" (linha ~201)

9. ADICIONE estas duas linhas na lista de getFirstNonEmpty:

   ```
   subscription.product?.plan_id as string | undefined,  // NOVO
   subscription.product?.id as string | undefined,       // NOVO
   ```

10. Clique em "Save" ou "Deploy"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TESTAR SE FUNCIONOU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ApÃ³s fazer o deploy (qualquer mÃ©todo), execute:

1. Teste de diagnÃ³stico:
   ```
   node debug-kiwify.js
   ```

   Deve mostrar:
   âœ… SERIA MAPEADO PARA: active (Premium deve ser ativado)

2. ForÃ§ar sincronizaÃ§Ã£o manual:

   Acesse no navegador (logado no sistema):
   http://localhost:5173/obrigado

   Ou execute via curl:
   ```
   curl -X POST https://keawapzxqoyesptwpwav.supabase.co/functions/v1/kiwify-api \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlYXdhcHp4cW95ZXNwdHdwd2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzE4MTAsImV4cCI6MjA3Njk0NzgxMH0.gc42HHODbHSsIIztIevnER6zt__CN19Mm7Ba0a98kM8" \
     -d '{"action":"sync_manual","emails":["birofov720@hh7f.com"]}'
   ```

3. Verifique a tabela user_subscriptions:

   VÃ¡ para: https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/editor

   Execute:
   ```sql
   SELECT
     u.email,
     s.plan,
     s.status,
     s.kiwify_plan_id
   FROM user_subscriptions s
   JOIN auth.users u ON u.id = s.user_id
   WHERE u.email = 'birofov720@hh7f.com';
   ```

   Deve retornar:
   plan: premium_quarterly (ou premium_monthly/annual)
   status: active
   kiwify_plan_id: 636ae5ac-1648-413d-9f24-ff428a9a723d

4. Teste no site:
   - FaÃ§a login com birofov720@hh7f.com
   - Acesse /app
   - Verifique se aparece "Conta Premium" no canto superior direito

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERIFICAR LOGS EM CASO DE ERRO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Se ainda nÃ£o funcionar:

1. Acesse os logs:
   https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/logs/edge-functions

2. Filtre por "kiwify-api"

3. Procure por erros relacionados a:
   - "subscription_upsert_failed"
   - "user_lookup_failed"
   - "resolvePlan"

4. Se encontrar erros, copie o correlation_id e procure nos logs completos

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECRETS NECESSÃRIOS (JÃ CONFIGURADOS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… KIWIFY_PLAN_MONTHLY_ID = b999e4a7-2372-4a01-a6ac-b08f0803e99c
âœ… KIWIFY_PLAN_QUARTERLY_ID = 636ae5ac-1648-413d-9f24-ff428a9a723d
â“ KIWIFY_PLAN_ANNUAL_ID = (vazio - ok se nÃ£o tiver plano anual)

Verificar em:
https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/settings/functions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESUMO DO QUE FOI FEITO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Problema identificado via debug script
âœ… CÃ³digo corrigido (busca plan_id em product.plan_id)
âœ… CÃ³digo commitado (72b430a) e enviado ao GitHub
âœ… Scripts de teste criados (debug-kiwify.js)
âœ… DocumentaÃ§Ã£o completa criada

FALTA FAZER:
ğŸš€ VocÃª fazer o deploy (siga OPÃ‡ÃƒO 1 ou 2 acima)
âœ… Testar apÃ³s deploy
âœ… Confirmar que plano Ã© ativado corretamente

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DÃšVIDAS?
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Execute este arquivo:
node debug-kiwify.js

E me envie a saÃ­da completa para diagnÃ³stico adicional.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

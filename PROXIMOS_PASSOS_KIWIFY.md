# üöÄ Pr√≥ximos Passos - Integra√ß√£o Kiwify

## ‚úÖ O que j√° foi feito

1. ‚úÖ Edge Function `kiwify-api` atualizada com:
   - Action `oauth_status` - testa autentica√ß√£o OAuth
   - Action `list_products` - lista produtos para obter IDs
2. ‚úÖ M√©todo `fetchProducts()` implementado no kiwifyClient
3. ‚úÖ P√°gina de testes `test-kiwify-secrets.html` criada
4. ‚úÖ Documenta√ß√£o `KIWIFY_API_SETUP.md` criada
5. ‚úÖ Commits realizados

---

## üìã O que voc√™ precisa fazer agora

### Passo 1: Configurar Secrets no Supabase Vault

**ATEN√á√ÉO**: Este √© o passo mais importante! Sem os Secrets configurados, nada vai funcionar.

1. Acesse o Supabase Vault:
   - URL: https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/settings/vault/secrets

2. Clique em **"New secret"** para cada um dos 3 secrets abaixo:

   | Nome do Secret | Valor a copiar |
   |----------------|----------------|
   | `KIWIFY_CLIENT_ID` | `4c7f47409-c212-45d1-aaf9-4a5d43dac808` |
   | `KIWIFY_CLIENT_SECRET` | `00d8f9dc83a5afeeee0fe459cfb5265272b95e5458c4908411273e5dfac` |
   | `KIWIFY_ACCOUNT_ID` | `av8qNBGVVoyVD75` |

3. **IMPORTANTE**:
   - Cole os valores EXATAMENTE como est√£o (sem espa√ßos antes ou depois)
   - Clique em "Save" ap√≥s adicionar cada secret
   - Aguarde ~30 segundos ap√≥s salvar todos

4. Verifique que os 3 secrets foram salvos:
   ```
   ‚úì KIWIFY_CLIENT_ID (hidden)
   ‚úì KIWIFY_CLIENT_SECRET (hidden)
   ‚úì KIWIFY_ACCOUNT_ID (hidden)
   ```

---

### Passo 2: Deploy da Edge Function

Agora voc√™ precisa fazer deploy da Edge Function atualizada no Supabase:

#### Op√ß√£o A: Via Supabase CLI (Recomendado)

```bash
# 1. Fazer login (se ainda n√£o estiver logado)
supabase login

# 2. Vincular ao projeto (se ainda n√£o estiver vinculado)
supabase link --project-ref keawapzxqoyesptwpwav

# 3. Deploy da fun√ß√£o kiwify-api
supabase functions deploy kiwify-api
```

#### Op√ß√£o B: Via Dashboard do Supabase

1. Acesse: https://supabase.com/dashboard/project/keawapzxqoyesptwpwav/functions
2. Clique em **kiwify-api**
3. Clique em **Deploy new version**
4. Copie o conte√∫do de `supabase/functions/kiwify-api/index.ts`
5. Cole no editor e clique **Deploy**

**ATEN√á√ÉO**: A Op√ß√£o A (CLI) √© MUITO mais confi√°vel, pois tamb√©m faz deploy dos arquivos em `_shared/`.

---

### Passo 3: Testar a Integra√ß√£o

Depois de configurar os Secrets e fazer deploy:

1. Abra o arquivo de teste no navegador:
   - Arquivo: `test-kiwify-secrets.html`
   - Ou acesse pela raiz do projeto

2. Clique nos 3 bot√µes de teste na ordem:

   **Teste 1: Autentica√ß√£o OAuth**
   - ‚úÖ Se funcionar: Vai mostrar "AUTENTICA√á√ÉO OK" com token v√°lido
   - ‚ùå Se falhar: Verifique se os Secrets est√£o corretos

   **Teste 2: Listar Produtos**
   - ‚úÖ Se funcionar: Vai mostrar lista de produtos com IDs
   - üìù ANOTE os Product IDs dos 3 planos (mensal/trimestral/anual)
   - ‚ùå Se falhar: Verifique se o Teste 1 passou

   **Teste 3: Sincronizar Assinaturas**
   - ‚úÖ Se funcionar: Vai sincronizar assinaturas existentes
   - ‚ö†Ô∏è Se n√£o houver assinaturas ativas, pode retornar vazio (√© normal)

---

### Passo 4: Configurar Product IDs (Opcional mas Recomendado)

Depois do Teste 2, voc√™ ter√° os Product IDs. Configure-os como Secrets para mapeamento preciso:

1. Volte ao Supabase Vault
2. Adicione 3 novos secrets com os IDs que voc√™ anotou:

   | Secret Name | Valor (exemplo) |
   |-------------|-----------------|
   | `KIWIFY_PLAN_MONTHLY_ID` | `prod_xxx...` (copie do teste) |
   | `KIWIFY_PLAN_QUARTERLY_ID` | `prod_yyy...` (copie do teste) |
   | `KIWIFY_PLAN_ANNUAL_ID` | `prod_zzz...` (copie do teste) |

**Nota**: Se voc√™ n√£o configurar estes, a fun√ß√£o vai usar fallback por frequ√™ncia de cobran√ßa (funciona, mas menos preciso).

---

## üêõ Troubleshooting

### Erro: "Unknown action: oauth_status"

**Causa**: Edge Function n√£o foi deployada ou est√° com vers√£o antiga.

**Solu√ß√£o**:
1. Fa√ßa deploy da fun√ß√£o: `supabase functions deploy kiwify-api`
2. Aguarde 1 minuto e teste novamente

---

### Erro: "Variavel KIWIFY_ACCOUNT_ID nao configurada"

**Causa**: Secrets n√£o est√£o configurados no Supabase Vault.

**Solu√ß√£o**:
1. Siga o **Passo 1** acima para adicionar os 3 Secrets
2. Aguarde 30 segundos ap√≥s salvar
3. Teste novamente

---

### Erro: "Invalid client credentials" ou "401 Unauthorized"

**Causa**: Credenciais incorretas ou copiadas com espa√ßo extra.

**Solu√ß√£o**:
1. V√° ao Supabase Vault
2. Delete os 3 Secrets existentes
3. Adicione novamente copiando EXATAMENTE como est√° no Passo 1
4. Certifique-se de n√£o ter espa√ßos antes ou depois

---

### Teste 1 passou, mas Teste 2 falha

**Causa**: M√©todo `fetchProducts()` pode n√£o estar funcionando.

**Solu√ß√£o**:
1. Verifique se fez deploy via CLI (n√£o s√≥ Dashboard)
2. Execute: `supabase functions deploy kiwify-api --no-verify-jwt`
3. Verifique logs: `supabase functions logs kiwify-api --follow`

---

## üìä Como Saber se Est√° Funcionando

Depois de concluir todos os passos, fa√ßa um teste completo:

1. **Teste de Compra Simulada**:
   - V√° em `/assinatura` no app
   - Clique em um dos planos
   - Complete o checkout na Kiwify
   - Aguarde ~1 minuto
   - Volte ao app e veja se mudou para Premium

2. **Consulta no Banco**:
   ```sql
   -- Ver assinaturas sincronizadas
   SELECT user_id, plan, status, kiwify_order_id, current_period_end
   FROM user_subscriptions
   WHERE plan != 'free'
   ORDER BY updated_at DESC;
   ```

3. **Consulta de Pagamentos**:
   ```sql
   -- Ver hist√≥rico de pagamentos
   SELECT user_id, kiwify_order_id, amount, status, paid_at
   FROM payment_history
   ORDER BY paid_at DESC
   LIMIT 10;
   ```

---

## ‚úÖ Checklist de Conclus√£o

- [ ] Secrets configurados no Supabase Vault (3 obrigat√≥rios)
- [ ] Edge Function kiwify-api deployada via CLI
- [ ] Teste 1 (OAuth) passou com sucesso
- [ ] Teste 2 (Produtos) passou e IDs anotados
- [ ] Teste 3 (Sync) executado (pode estar vazio)
- [ ] Product IDs configurados como Secrets (opcional)
- [ ] Teste de compra real realizado
- [ ] Banco de dados mostra assinatura ativa

---

## üìö Documenta√ß√£o Adicional

- **Guia Completo**: Ver `KIWIFY_API_SETUP.md`
- **Logs das Fun√ß√µes**:
  ```bash
  supabase functions logs kiwify-api --follow
  supabase functions logs kiwify-sync --follow
  ```

---

**√öltima atualiza√ß√£o**: 2025-01-11
**Status**: Pronto para configura√ß√£o e teste
